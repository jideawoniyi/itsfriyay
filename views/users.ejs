<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1" /> -->
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="/css/style.css">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://getbootstrap.com/docs/5.3/assets/css/docs.css"
      rel="stylesheet"
    />
    <title>Users</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
      $(document).ready(function() {
      console.log('jQuery is working');
      });
    </script>
  </head>

  <!-- style="background-color: rgb(35, 35, 35); -->
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <a class="navbar-brand" href="#">USERS</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#menu" aria-controls="menu" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="menu">
          <ul class="navbar-nav mr-auto mt-2 mt-lg-0">
            <% if (user) { %>
              <li class="nav-item"><a class="nav-link" href="/dashboard">Dashboard</a></li>
              <li class="nav-item"><a class="nav-link" href="/logout/<%= user.username %>">Log out</a></li>
            <% } else { %>
              <li class="nav-item"><a class="nav-link" href="/">Login</a></li>
              <li class="nav-item"><a class="nav-link" href="/register">Register</a></li>
            <%
            } %>
          </ul>
      </div>
    </nav>

      <!-- <div class="flame-spiral"> -->
      <!-- Search bar and dropdown menu -->

      <div class="outer-flex">
        <div class="inner-flex" style="display: flex; flex-direction: row; align-items: center; justify-content: center;">
          <form id="form"  action="/search" method="get">
            <div class="form-group">
              <label for="searchBy">Search by:</label>
              <select name="searchBy" id="searchBy" class="form-control">
                <!-- <option value="" selected>Select an option</option> -->
                <option value="all" selected>All Users</option>
                <option value="phonenumber">Phone Number</option>
                <option value="email">Email</option>
                <option value="username">Username</option>
                <option value="status">Status</option>
                <option value="walletId">Wallet Id</option>
                <option value="walletStatus">Wallet Status</option>
              </select>
      
              <div id="statusDropdown" style="display: none;">
                <label for="statusOption">Status:</label>
                <select name="statusOption" id="statusOption" class="form-control">
                  <option value="online">Online</option>
                  <option value="offline">Offline</option>
                </select>
              </div>
            </div>
            <div class="form-group" id="searchBox" style="display: none;">
              <label for="searchTerm">Search term:</label>
              <input type="text" name="searchTerm" id="searchTerm" class="form-control" />
            </div>
            <button id="btn" style="display: none;" type="submit" class="btn btn-primary">Search</button>
          </form>
      
          <form id="download-form" action="/download" method="post" class="form-inline">
            <div class="form-group">
              <label for="downloadType">Download as:</label>
              <select name="downloadType" id="downloadType" class="form-control">
                <option value="pdf">PDF</option>
                <option value="excel">Excel</option>
                <option value="plaintext">Plain Text</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary btn-sm my-2">Download</button>
          </form>
          
        </div>
      </div>
    

        <!-- JavaScript to show/hide status submenu -->
      <script>
        
   
        window.onload = function() {
  const form = document.getElementById('form');
  const input = document.getElementById('searchTerm');
  const searchBy = document.getElementById('searchBy');
  const searchBox = document.getElementById('searchBox');   
  const statusDropdown = document.getElementById('statusDropdown');
  const button = document.getElementById('btn');

  form.addEventListener('submit', (event) => {
    // Remove any previously appended error message
    const errorMessage = document.querySelector('#form h6');
    if (errorMessage) {
      form.removeChild(errorMessage);
    }

    // Only show error message if search box is not hidden and searchBy value is not "all" or "status"
    if (input.style.display !== 'none' && searchBy.value !== 'all' && searchBy.value !== 'status' && input.value === '') {
      const errorMessage = document.createElement('h6');
      errorMessage.textContent = 'Search criteria must be filled out';
      form.appendChild(errorMessage);

      // Prevent form submission if error message is shown
      event.preventDefault();
    }
  });

  searchBy.addEventListener('change', () => {
    if (searchBy.value === 'status') {
      searchBox.style.display = 'none';
      statusDropdown.style.display = 'block';
      button.style.display = 'block';
    } else if (searchBy.value === 'all') {
      searchBox.style.display = 'none';
      statusDropdown.style.display = 'none';
    } else {
      searchBox.style.display = 'block';
      statusDropdown.style.display = 'none';
          button.style.display = 'block';
          }
  });
};


</script>

<div class="container">
  <%
    let onlineCount = 0;
    let offlineCount = 0;
    users.forEach((user) => {
      if (user.status == 'online') {
        onlineCount++;
      } else {
        offlineCount++;
      }
    });
  %>
 
  

  <br>
 <div class="container-fluid">
  <div class="row">
    <div class="col-md-12 col-lg-6 col-sm-12 " style="background-color: rgb(48, 86, 48); padding: 10px;">
      <h5 style="color: white;">ONLINE </h5>
      <button type="button" class="btn btn-sm btn-success">
        Online Count
        <span class="badge badge-success" title="Online"><%= onlineCount %></span>
      </button>
      <br>
      <br>
      <% users.forEach((user, index) => {
        if (user.status == 'online') { %>
          <button type="button" class="btn btn-sm btn-success popover-dismiss" style="white-space: nowrap;" role="button" data-toggle="popover" data-trigger="focus" title=" <%= user.username %>" data-placement="bottom" data-content="
            User Name: <%= user.username %>
            Phone Number: <%= user.phonenumber %>
            Email: <%= user.email %>
            Status: <%= user.status %>
            Last Seen: <%= user.lastSeen %>"
          >
            <%= user.username %>
          </button>
      <% }
      }); %>
    </div>
    <br><br>
    <div class="col-md-12 col-lg-6 col-sm-12 " style="background-color: rgb(79, 86, 79); padding: 10px;">
      <h5 style="color: white;">OFFLINE </h5>
      <button type="button" class="btn btn-sm btn-secondary" >
        Offline Count
        <span class="badge badge-danger" title="Offline"><%= offlineCount %></span>
      </button>
      <br>
      <br>
      <% users.forEach((user, index) => {
        if (user.status == 'offline') { %>
          <button type="button" class="btn btn-sm btn-secondary popover-dismiss" style="white-space: nowrap;" role="button" data-toggle="popover" data-trigger="focus" title=" <%= user.username %>" data-placement="bottom" data-content="
            <p>User Name: <%= user.username %></p>
            <p>Phone Number: <%= user.phonenumber %></p>
            <p>Email: <%= user.email %></p>
            <p>Status: <%= user.status %></p>
            <p>Last Seen: <%= user.lastSeen %></p>
          </div></div>'"
          >
            <%= user.username %>
          </button>
      <% }
      }); %>
    </div>
  </div>
</div>
</div>


<script>
$(function () {
  $('[data-toggle="popover"]').popover()
})

$('.popover-dismiss').popover({
  trigger: 'focus'
})

$('.alert').alert()
</script>


          <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  </body>
  </html>